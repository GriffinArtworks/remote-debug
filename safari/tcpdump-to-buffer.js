var bplist_parse = require('bplist-parser');
var bufferpack = require('bufferpack');
var util = require('util');
var fs = require('fs');

var str = '0103 0304 0101 080a 3f6a b94e 0000 0000';

var str = '0x0000:  6000 0000 0020 0640 0000 0000 0000 0000  `......@........\n' + 
  '0x0010:  0000 0000 0000 0001 0000 0000 0000 0000  ................\n' +
  '0x0020:  0000 0000 0000 0001 e79e 6c69 f416 4d29  ..........li..M)\n' +
  '0x0030:  3665 a36e 8010 23d7 0028 0000 0101 080a  6e.n..#..(......\n' +
  '0x0040:  3f6a b94e 3f6a b94e                      ?j.N?j.N';

var str =
  "0x0040:  40c1 060f 40c1 060f 6270 6c69 7374 3030  @...@...bplist00\n" +
  "0x0050:  d201 0203 0c5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d4 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 5f10 1b57 4952 4170 706c 6963  ...._..WIRApplic\n" +
  "0x0080:  6174 696f 6e49 6465 6e74 6966 6965 724b  ationIdentifierK\n" +
  "0x0090:  6579 5f10 1557 4952 496e 6469 6361 7465  ey_..WIRIndicate\n" +
  "0x00a0:  456e 6162 6c65 644b 6579 5f10 1a57 4952  EnabledKey_..WIR\n" +
  "0x00b0:  436f 6e6e 6563 7469 6f6e 4964 656e 7469  ConnectionIdenti\n" +
  "0x00c0:  6669 6572 4b65 795f 1014 5749 5250 6167  fierKey_..WIRPag\n" +
  "0x00d0:  6549 6465 6e74 6966 6965 724b 6579 5f10  eIdentifierKey_.\n" +
  "0x00e0:  1663 6f6d 2e61 7070 6c65 2e6d 6f62 696c  .com.apple.mobil\n" +
  "0x00f0:  6573 6166 6172 6908 5f10 2436 4339 4236  esafari._.$6C9B6\n" +
  "0x0100:  4446 412d 3730 4532 2d34 3033 442d 3845  DFA-70E2-403D-8E\n" +
  "0x0110:  3836 2d45 4246 3837 4446 3233 3845 3210  86-EBF87DF238E2.\n" +
  "0x0120:  015f 101c 5f72 7063 5f66 6f72 7761 7264  ._.._rpc_forward\n" +
  "0x0130:  496e 6469 6361 7465 5765 6256 6965 773a  IndicateWebView:\n" +
  "0x0140:  080d 1823 2c4a 627f 96af b0d7 d900 0000  ...#,Jb.........\n" +
  "0x0150:  0000 0001 0100 0000 0000 0000 0d00 0000  ................\n" +
  "0x0160:  0000 0000 0000 0000 0000 0000 f8         .............";

// var str =
//   "0x0040:  40c0 d748 40c0 d748 6270 6c69 7374 3030  @..H@..Hbplist00\n" +
//   "0x0050:  d201 0203 045a 5f5f 7365 6c65 6374 6f72  .....Z__selector\n" +
//   "0x0060:  5a5f 5f61 7267 756d 656e 745f 1011 5f72  Z__argument_.._r\n" +
//   "0x0070:  7063 5f72 6570 6f72 7453 6574 7570 3ad2  pc_reportSetup:.\n" +
//   "0x0080:  0506 0708 5f10 1357 4952 5369 6d75 6c61  ...._..WIRSimula\n" +
//   "0x0090:  746f 724e 616d 654b 6579 5f10 1457 4952  torNameKey_..WIR\n" +
//   "0x00a0:  5369 6d75 6c61 746f 7242 7569 6c64 4b65  SimulatorBuildKe\n" +
//   "0x00b0:  795f 1010 6950 686f 6e65 2053 696d 756c  y_..iPhone.Simul\n" +
//   "0x00c0:  6174 6f72 5631 3041 3430 3308 0d18 2337  atorV10A403...#7\n" +
//   "0x00d0:  3c52 697c 0000 0000 0000 0101 0000 0000  <Ri|............\n" +
//   "0x00e0:  0000 0009 0000 0000 0000 0000 0000 0000  ................\n" +
//   "0x00f0:  0000 0083                                ....";

// var str =
//     "0x0040:  40c0 d74a 40c0 d74a 6270 6c69 7374 3030  @..J@..Jbplist00\n" +
//     "0x0050:  d201 0203 045a 5f5f 7365 6c65 6374 6f72  .....Z__selector\n" +
//     "0x0060:  5a5f 5f61 7267 756d 656e 745f 101c 5f72  Z__argument_.._r\n" +
//     "0x0070:  7063 5f61 7070 6c69 6361 7469 6f6e 5365  pc_applicationSe\n" +
//     "0x0080:  6e74 4c69 7374 696e 673a d205 0607 085f  ntListing:....._\n" +
//     "0x0090:  101b 5749 5241 7070 6c69 6361 7469 6f6e  ..WIRApplication\n" +
//     "0x00a0:  4964 656e 7469 6669 6572 4b65 795d 5749  IdentifierKey]WI\n" +
//     "0x00b0:  524c 6973 7469 6e67 4b65 795f 1016 636f  RListingKey_..co\n" +
//     "0x00c0:  6d2e 6170 706c 652e 6d6f 6269 6c65 7361  m.apple.mobilesa\n" +
//     "0x00d0:  6661 7269 d109 0a51 31d3 0b0c 0d0e 0f10  fari...Q1.......\n" +
//     "0x00e0:  5f10 1457 4952 5061 6765 4964 656e 7469  _..WIRPageIdenti\n" +
//     "0x00f0:  6669 6572 4b65 795b 5749 5254 6974 6c65  fierKey[WIRTitle\n" +
//     "0x0100:  4b65 7959 5749 5255 524c 4b65 7910 0156  KeyYWIRURLKey..V\n" +
//     "0x0110:  476f 6f67 6c65 5f10 1868 7474 703a 2f2f  Google_..http://\n" +
//     "0x0120:  7777 772e 676f 6f67 6c65 2e63 6f2e 756b  www.google.co.uk\n" +
//     "0x0130:  2f08 0d18 2342 4765 738c 8f91 98af bbc5  /...#BGes.......\n" +
//     "0x0140:  c7ce 0000 0000 0000 0101 0000 0000 0000  ................\n" +
//     "0x0150:  0011 0000 0000 0000 0000 0000 0000 0000  ................\n" +
//     "0x0160:  00e9                                     ..\n";

var str =
  "0x0040:  40c1 0665 40c1 0665 6270 6c69 7374 3030  @..e@..ebplist00\n" +
  "0x0050:  d201 0203 0c5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d4 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 5f10 1b57 4952 4170 706c 6963  ...._..WIRApplic\n" +
  "0x0080:  6174 696f 6e49 6465 6e74 6966 6965 724b  ationIdentifierK\n" +
  "0x0090:  6579 5f10 1a57 4952 436f 6e6e 6563 7469  ey_..WIRConnecti\n" +
  "0x00a0:  6f6e 4964 656e 7469 6669 6572 4b65 795c  onIdentifierKey\\\n" +
  "0x00b0:  5749 5253 656e 6465 724b 6579 5f10 1457  WIRSenderKey_..W\n" +
  "0x00c0:  4952 5061 6765 4964 656e 7469 6669 6572  IRPageIdentifier\n" +
  "0x00d0:  4b65 795f 1016 636f 6d2e 6170 706c 652e  Key_..com.apple.\n" +
  "0x00e0:  6d6f 6269 6c65 7361 6661 7269 5f10 2436  mobilesafari_.$6\n" +
  "0x00f0:  4339 4236 4446 412d 3730 4532 2d34 3033  C9B6DFA-70E2-403\n" +
  "0x0100:  442d 3845 3836 2d45 4246 3837 4446 3233  D-8E86-EBF87DF23\n" +
  "0x0110:  3845 325f 1024 3030 4641 3934 3937 2d34  8E2_.$00FA9497-4\n" +
  "0x0120:  4634 422d 3431 3732 2d41 3342 362d 3136  F4B-4172-A3B6-16\n" +
  "0x0130:  4444 3932 4535 4337 3342 1001 5f10 185f  DD92E5C73B.._.._\n" +
  "0x0140:  7270 635f 666f 7277 6172 6453 6f63 6b65  rpc_forwardSocke\n" +
  "0x0150:  7453 6574 7570 3a00 0800 0d00 1800 2300  tSetup:.......#.\n" +
  "0x0160:  2c00 4a00 6700 7400 8b00 a400 cb00 f200  ,.J.g.t.........\n" +
  "0x0170:  f400 0000 0000 0002 0100 0000 0000 0000  ................\n" +
  "0x0180:  0d00 0000 0000 0000 0000 0000 0000 0001  ................\n" +
  "0x0190:  0f                                       .";

var str =
  "0x0040:  4105 67ff 4105 67ff 6270 6c69 7374 3030  A.g.A.g.bplist00\n" +
  "0x0050:  d201 0203 0e5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d5 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 0c0d 5f10 1b57 4952 4170 706c  ......_..WIRAppl\n" +
  "0x0080:  6963 6174 696f 6e49 6465 6e74 6966 6965  icationIdentifie\n" +
  "0x0090:  724b 6579 5f10 1057 4952 536f 636b 6574  rKey_..WIRSocket\n" +
  "0x00a0:  4461 7461 4b65 795f 101a 5749 5243 6f6e  DataKey_..WIRCon\n" +
  "0x00b0:  6e65 6374 696f 6e49 6465 6e74 6966 6965  nectionIdentifie\n" +
  "0x00c0:  724b 6579 5c57 4952 5365 6e64 6572 4b65  rKey\\WIRSenderKe\n" +
  "0x00d0:  795f 1014 5749 5250 6167 6549 6465 6e74  y_..WIRPageIdent\n" +
  "0x00e0:  6966 6965 724b 6579 5f10 1663 6f6d 2e61  ifierKey_..com.a\n" +
  "0x00f0:  7070 6c65 2e6d 6f62 696c 6573 6166 6172  pple.mobilesafar\n" +
  "0x0100:  694f 10c7 7b22 6d65 7468 6f64 223a 2252  iO..{\"method\":\"R\n" +
  "0x0110:  756e 7469 6d65 2e65 7661 6c75 6174 6522  untime.evaluate\"\n" +
  "0x0120:  2c22 7061 7261 6d73 223a 7b22 6578 7072  ,\"params\":{\"expr\n" +
  "0x0130:  6573 7369 6f6e 223a 2261 6c65 7274 285c  ession\":\"alert(\\\n" +
  "0x0140:  2248 656c 6c6f 5c22 2922 2c22 6f62 6a65  \"Hello\\\")\",\"obje\n" +
  "0x0150:  6374 4772 6f75 7022 3a22 636f 6e73 6f6c  ctGroup\":\"consol\n" +
  "0x0160:  6522 2c22 696e 636c 7564 6543 6f6d 6d61  e\",\"includeComma\n" +
  "0x0170:  6e64 4c69 6e65 4150 4922 3a74 7275 652c  ndLineAPI\":true,\n" +
  "0x0180:  2264 6f4e 6f74 5061 7573 654f 6e45 7863  \"doNotPauseOnExc\n" +
  "0x0190:  6570 7469 6f6e 7341 6e64 4d75 7465 436f  eptionsAndMuteCo\n" +
  "0x01a0:  6e73 6f6c 6522 3a74 7275 652c 2272 6574  nsole\":true,\"ret\n" +
  "0x01b0:  7572 6e42 7956 616c 7565 223a 6661 6c73  urnByValue\":fals\n" +
  "0x01c0:  657d 2c22 6964 223a 3530 7d5f 1024 3643  e},\"id\":50}_.$6C\n" +
  "0x01d0:  3942 3644 4641 2d37 3045 322d 3430 3344  9B6DFA-70E2-403D\n" +
  "0x01e0:  2d38 4538 362d 4542 4638 3744 4632 3338  -8E86-EBF87DF238\n" +
  "0x01f0:  4532 5f10 2432 3939 3536 3542 322d 4339  E2_.$299565B2-C9\n" +
  "0x0200:  3941 2d34 3137 342d 4131 4237 2d35 3939  9A-4174-A1B7-599\n" +
  "0x0210:  3342 3443 3431 3946 3310 015f 1017 5f72  3B4C419F3.._.._r\n" +
  "0x0220:  7063 5f66 6f72 7761 7264 536f 636b 6574  pc_forwardSocket\n" +
  "0x0230:  4461 7461 3a00 0800 0d00 1800 2300 2e00  Data:.......#...\n" +
  "0x0240:  4c00 5f00 7c00 8900 a000 b901 8301 aa01  L._.|...........\n" +
  "0x0250:  d101 d300 0000 0000 0002 0100 0000 0000  ................\n" +
  "0x0260:  0000 0f00 0000 0000 0000 0000 0000 0000  ................\n" +
  "0x0270:  0001 ed                                  ...";

var str =
  "0x0040:  4134 853e 4134 853e 6270 6c69 7374 3030  A4.>A4.>bplist00\n" +
  "0x0050:  d201 0203 0c5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d4 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 5f10 1b57 4952 4170 706c 6963  ...._..WIRApplic\n" +
  "0x0080:  6174 696f 6e49 6465 6e74 6966 6965 724b  ationIdentifierK\n" +
  "0x0090:  6579 5f10 1557 4952 496e 6469 6361 7465  ey_..WIRIndicate\n" +
  "0x00a0:  456e 6162 6c65 644b 6579 5f10 1a57 4952  EnabledKey_..WIR\n" +
  "0x00b0:  436f 6e6e 6563 7469 6f6e 4964 656e 7469  ConnectionIdenti\n" +
  "0x00c0:  6669 6572 4b65 795f 1014 5749 5250 6167  fierKey_..WIRPag\n" +
  "0x00d0:  6549 6465 6e74 6966 6965 724b 6579 5f10  eIdentifierKey_.\n" +
  "0x00e0:  1663 6f6d 2e61 7070 6c65 2e6d 6f62 696c  .com.apple.mobil\n" +
  "0x00f0:  6573 6166 6172 6908 5f10 2433 4243 4634  esafari._.$3BCF4\n" +
  "0x0100:  3530 452d 3832 4631 2d34 4543 332d 3937  50E-82F1-4EC3-97\n" +
  "0x0110:  4646 2d41 3938 4445 3731 4334 3746 4510  FF-A98DE71C47FE.\n" +
  "0x0120:  015f 101c 5f72 7063 5f66 6f72 7761 7264  ._.._rpc_forward\n" +
  "0x0130:  496e 6469 6361 7465 5765 6256 6965 773a  IndicateWebView:\n" +
  "0x0140:  080d 1823 2c4a 627f 96af b0d7 d900 0000  ...#,Jb.........\n" +
  "0x0150:  0000 0001 0100 0000 0000 0000 0d00 0000  ................\n" +
  "0x0160:  0000 0000 0000 0000 0000 0000 f8         .............";

var str =
  "0x0040:  4135 df5e 4135 df5e 6270 6c69 7374 3030  A5.^A5.^bplist00\n" +
  "0x0050:  d201 0203 0c5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d4 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 5f10 1b57 4952 4170 706c 6963  ...._..WIRApplic\n" +
  "0x0080:  6174 696f 6e49 6465 6e74 6966 6965 724b  ationIdentifierK\n" +
  "0x0090:  6579 5f10 1557 4952 496e 6469 6361 7465  ey_..WIRIndicate\n" +
  "0x00a0:  456e 6162 6c65 644b 6579 5f10 1a57 4952  EnabledKey_..WIR\n" +
  "0x00b0:  436f 6e6e 6563 7469 6f6e 4964 656e 7469  ConnectionIdenti\n" +
  "0x00c0:  6669 6572 4b65 795f 1014 5749 5250 6167  fierKey_..WIRPag\n" +
  "0x00d0:  6549 6465 6e74 6966 6965 724b 6579 5f10  eIdentifierKey_.\n" +
  "0x00e0:  1663 6f6d 2e61 7070 6c65 2e6d 6f62 696c  .com.apple.mobil\n" +
  "0x00f0:  6573 6166 6172 6909 5f10 2433 4243 4634  esafari._.$3BCF4\n" +
  "0x0100:  3530 452d 3832 4631 2d34 4543 332d 3937  50E-82F1-4EC3-97\n" +
  "0x0110:  4646 2d41 3938 4445 3731 4334 3746 4510  FF-A98DE71C47FE.\n" +
  "0x0120:  015f 101c 5f72 7063 5f66 6f72 7761 7264  ._.._rpc_forward\n" +
  "0x0130:  496e 6469 6361 7465 5765 6256 6965 773a  IndicateWebView:\n" +
  "0x0140:  080d 1823 2c4a 627f 96af b0d7 d900 0000  ...#,Jb.........\n" +
  "0x0150:  0000 0001 0100 0000 0000 0000 0d00 0000  ................\n" +
  "0x0160:  0000 0000 0000 0000 0000 0000 f8         .............";

var str =
  "0x0040:  413c acf2 413c acf2 6270 6c69 7374 3030  A<..A<..bplist00\n" +
  "0x0050:  d201 0203 0c5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
  "0x0060:  5a5f 5f73 656c 6563 746f 72d4 0405 0607  Z__selector.....\n" +
  "0x0070:  0809 0a0b 5f10 1b57 4952 4170 706c 6963  ...._..WIRApplic\n" +
  "0x0080:  6174 696f 6e49 6465 6e74 6966 6965 724b  ationIdentifierK\n" +
  "0x0090:  6579 5f10 1a57 4952 436f 6e6e 6563 7469  ey_..WIRConnecti\n" +
  "0x00a0:  6f6e 4964 656e 7469 6669 6572 4b65 795c  onIdentifierKey\\\n" +
  "0x00b0:  5749 5253 656e 6465 724b 6579 5f10 1457  WIRSenderKey_..W\n" +
  "0x00c0:  4952 5061 6765 4964 656e 7469 6669 6572  IRPageIdentifier\n" +
  "0x00d0:  4b65 795f 1016 636f 6d2e 6170 706c 652e  Key_..com.apple.\n" +
  "0x00e0:  6d6f 6269 6c65 7361 6661 7269 5f10 2432  mobilesafari_.$2\n" +
  "0x00f0:  4541 3341 3430 342d 4545 3146 2d34 3941  EA3A404-EE1F-49A\n" +
  "0x0100:  342d 3837 3632 2d32 3343 4644 3138 3635  4-8762-23CFD1865\n" +
  "0x0110:  4333 375f 1024 4534 4645 3841 3335 2d43  C37_.$E4FE8A35-C\n" +
  "0x0120:  3236 412d 3439 3441 2d42 3646 362d 3646  26A-494A-B6F6-6F\n" +
  "0x0130:  3143 3546 4342 4532 3031 1001 5f10 185f  1C5FCBE201.._.._\n" +
  "0x0140:  7270 635f 666f 7277 6172 6453 6f63 6b65  rpc_forwardSocke\n" +
  "0x0150:  7453 6574 7570 3a00 0800 0d00 1800 2300  tSetup:.......#.\n" +
  "0x0160:  2c00 4a00 6700 7400 8b00 a400 cb00 f200  ,.J.g.t.........\n" +
  "0x0170:  f400 0000 0000 0002 0100 0000 0000 0000  ................\n" +
  "0x0180:  0d00 0000 0000 0000 0000 0000 0000 0001  ................\n" +
  "0x0190:  0f                                       .";

// var str =
//   "0x0040:  413c ad07 413c ad07 6270 6c69 7374 3030  A<..A<..bplist00\n" +
//   "0x0050:  d201 0203 0e5a 5f5f 6172 6775 6d65 6e74  .....Z__argument\n" +
//   "0x0060:  5a5f 5f73 656c 6563 746f 72d5 0405 0607  Z__selector.....\n" +
//   "0x0070:  0809 0a0b 0c0d 5f10 1b57 4952 4170 706c  ......_..WIRAppl\n" +
//   "0x0080:  6963 6174 696f 6e49 6465 6e74 6966 6965  icationIdentifie\n" +
//   "0x0090:  724b 6579 5f10 1057 4952 536f 636b 6574  rKey_..WIRSocket\n" +
//   "0x00a0:  4461 7461 4b65 795f 101a 5749 5243 6f6e  DataKey_..WIRCon\n" +
//   "0x00b0:  6e65 6374 696f 6e49 6465 6e74 6966 6965  nectionIdentifie\n" +
//   "0x00c0:  724b 6579 5c57 4952 5365 6e64 6572 4b65  rKey\\WIRSenderKe\n" +
//   "0x00d0:  795f 1014 5749 5250 6167 6549 6465 6e74  y_..WIRPageIdent\n" +
//   "0x00e0:  6966 6965 724b 6579 5f10 1663 6f6d 2e61  ifierKey_..com.a\n" +
//   "0x00f0:  7070 6c65 2e6d 6f62 696c 6573 6166 6172  pple.mobilesafar\n" +
//   "0x0100:  694f 1024 7b22 6d65 7468 6f64 223a 2249  iO.${\"method\":\"I\n" +
//   "0x0110:  6e73 7065 6374 6f72 2e65 6e61 626c 6522  nspector.enable\"\n" +
//   "0x0120:  2c22 6964 223a 317d 5f10 2432 4541 3341  ,\"id\":1}_.$2EA3A\n" +
//   "0x0130:  3430 342d 4545 3146 2d34 3941 342d 3837  404-EE1F-49A4-87\n" +
//   "0x0140:  3632 2d32 3343 4644 3138 3635 4333 375f  62-23CFD1865C37_\n" +
//   "0x0150:  1024 4534 4645 3841 3335 2d43 3236 412d  .$E4FE8A35-C26A-\n" +
//   "0x0160:  3439 3441 2d42 3646 362d 3646 3143 3546  494A-B6F6-6F1C5F\n" +
//   "0x0170:  4342 4532 3031 1001 5f10 175f 7270 635f  CBE201.._.._rpc_\n" +
//   "0x0180:  666f 7277 6172 6453 6f63 6b65 7444 6174  forwardSocketDat\n" +
//   "0x0190:  613a 0008 000d 0018 0023 002e 004c 005f  a:.......#...L._\n" +
//   "0x01a0:  007c 0089 00a0 00b9 00e0 0107 012e 0130  .|.............0\n" +
//   "0x01b0:  0000 0000 0000 0201 0000 0000 0000 000f  ................\n" +
//   "0x01c0:  0000 0000 0000 0000 0000 0000 0000 014a  ...............J";

var str = fs.readFileSync('packet.txt', 'utf-8');

// clean up
var clean = [];
str.trim().split('\n').forEach(function (s) {
  console.log(s.slice(9, 48));
  clean.push(s.slice(9, 48));
});

var data = [];
clean.join(' ').split(' ').map(function (pair) {
  pair = pair.trim();
  if (pair) {
    var first = parseInt(pair.slice(0,2), 16);
    var second = parseInt(pair.slice(2), 16);
    if( !isNaN(first) ) {
      data.push(first);
    }
    if( !isNaN(second) ) {
      data.push(second);
    }
  }
});

// console.log(data.join(','));
console.log(data.length);

var buf = new Buffer(data.slice(8));

console.log(buf);
console.log(buf.length);

var plist;
try {
  plist = bplist_parse.parseBuffer(buf);
} catch (e) {
  console.log(e);
}

console.log(util.inspect(plist, false, null));

if( plist[0].__argument.WIRSocketDataKey ) {
  console.log(plist[0].__argument.WIRSocketDataKey.toString());
}
if( plist[0].__argument.WIRMessageDataKey ) {
  console.log(plist[0].__argument.WIRMessageDataKey.toString());
}


